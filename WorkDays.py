import json
from datetime import datetime
import mysql.connector
from typing import List, Dict, Any


class WorkCalendarProcessor:
    # 数据库连接配置
    DB_CONFIG = {
        'host': '192.168.4.80',
        'database': 'data_warehouse_prod',
        'user': 'root',
        'password': '4DrveSG!jTu%'
    }

    # 日期类型常量
    WORK_DAY = 1
    NON_WORK_DAY = 0

    def __init__(self):
        """初始化数据库连接"""
        self.conn = mysql.connector.connect(**self.DB_CONFIG)
        self.cursor = self.conn.cursor(prepared=True)

    @staticmethod
    def process_date_string(date_str: str) -> List[str]:
        """处理日期字符串，返回日期列表"""
        if not date_str:
            return []
        return [date.split(' ')[0] for date in date_str.split(',') if date.strip()]

    def insert_calendar_record(self, date_str: str, is_workday: int) -> None:
        """插入日历记录"""
        if not date_str:
            return
        try:
            # 将日期字符串转换为datetime对象
            date_obj = datetime.strptime(date_str, '%Y-%m-%d')
            sql = """
            INSERT INTO sys_canendar (date_value, is_workday) 
            VALUES (%s, %s)
            ON DUPLICATE KEY UPDATE is_workday = VALUES(is_workday)
            """
            self.cursor.execute(sql, (date_obj, is_workday))
        except ValueError as e:
            print(f"日期格式错误: {date_str}, 错误信息: {str(e)}")
        except Exception as e:
            print(f"插入记录时发生错误: {str(e)}")
            raise

    def process_monthly_data(self, monthly_data: Dict[str, Any]) -> None:
        """处理每月数据"""
        try:
            # 处理工作日
            for date in self.process_date_string(monthly_data.get('WorkDays', '')):
                self.insert_calendar_record(date, self.WORK_DAY)

            # 处理周末
            for date in self.process_date_string(monthly_data.get('Weekend', '')):
                self.insert_calendar_record(date, self.NON_WORK_DAY)

            # 处理节假日
            for festival in monthly_data.get('Festivals', []):
                date = festival['Date'].split(' ')[0]
                self.insert_calendar_record(date, self.NON_WORK_DAY)

            # 处理调休公休日
            for date in self.process_date_string(monthly_data.get('PublicHoliday', '')):
                self.insert_calendar_record(date, self.NON_WORK_DAY)

            # 处理调休工作日
            for date in self.process_date_string(monthly_data.get('DaysOffWorkDay', '')):
                self.insert_calendar_record(date, self.WORK_DAY)

        except Exception as e:
            print(f"处理月度数据时发生错误: {str(e)}")
            raise

    def process_work_calendar_data(self, json_data: str) -> None:
        """处理工作日历数据"""
        try:
            # 解析JSON数据
            data = json.loads(json_data)
            calendar_data = data['Data']['WorkCalendarDatas'][0]
            monthly_details = calendar_data['MonthlyDetails']

            # 开始事务
            self.conn.start_transaction()

            # 处理每个月的数据
            for month_data in monthly_details:
                self.process_monthly_data(month_data)

            # 提交事务
            self.conn.commit()
            print("数据处理完成并已成功保存到数据库")

        except Exception as e:
            # 发生错误时回滚
            self.conn.rollback()
            print(f"处理数据时发生错误: {str(e)}")
            raise
        finally:
            # 关闭数据库连接
            self.close()

    def close(self):
        """关闭数据库连接"""
        if self.cursor:
            self.cursor.close()
        if self.conn:
            self.conn.close()


def main():
    # JSON数据
    json_data = '''{
    "Data": {
        "WorkCalendarDatas": [
            {
                "Name": "奇点能源工作日历-2025-f5f",
                "Year": 2025,
                "AttendanceOrg": "900606065",
                "CreatedTime": "2024-01-01 02:00:05",
                "ModifiedTime": "2025-01-17 14:25:25",
                "MonthlyDetails": [
                    {
                        "NumberOfMonth": 1,
                        "WorkDays": "2025-01-02 星期四,2025-01-03 星期五,2025-01-06 星期一,2025-01-07 星期二,2025-01-08 星期三,2025-01-09 星期四,2025-01-10 星期五,2025-01-13 星期一,2025-01-14 星期二,2025-01-15 星期三,2025-01-16 星期四,2025-01-17 星期五,2025-01-20 星期一,2025-01-21 星期二,2025-01-22 星期三,2025-01-23 星期四,2025-01-24 星期五,",
                        "Weekend": "2025-01-04 星期六,2025-01-05 星期日,2025-01-12 星期日,2025-01-19 星期日,",
                        "Festivals": [
                            {
                                "Date": "2025-01-01 星期三",
                                "Name": "元旦"
                            },
                            {
                                "Date": "2025-01-28 星期二",
                                "Name": "春节"
                            },
                            {
                                "Date": "2025-01-29 星期三",
                                "Name": "春节"
                            },
                            {
                                "Date": "2025-01-30 星期四",
                                "Name": "春节"
                            },
                            {
                                "Date": "2025-01-31 星期五",
                                "Name": "春节"
                            }
                        ],
                        "PublicHoliday": "2025-01-27 星期一,",
                        "DaysOffWorkDay": "2025-01-11 星期六,2025-01-18 星期六,2025-01-25 星期六,2025-01-26 星期日,"
                    },
                    {
                        "NumberOfMonth": 2,
                        "WorkDays": "2025-02-05 星期三,2025-02-06 星期四,2025-02-07 星期五,2025-02-10 星期一,2025-02-11 星期二,2025-02-12 星期三,2025-02-13 星期四,2025-02-14 星期五,2025-02-17 星期一,2025-02-18 星期二,2025-02-19 星期三,2025-02-20 星期四,2025-02-21 星期五,2025-02-24 星期一,2025-02-25 星期二,2025-02-26 星期三,2025-02-27 星期四,2025-02-28 星期五,",
                        "Weekend": "2025-02-09 星期日,2025-02-15 星期六,2025-02-16 星期日,2025-02-23 星期日,",
                        "Festivals": [],
                        "PublicHoliday": "2025-02-01 星期六,2025-02-02 星期日,2025-02-03 星期一,2025-02-04 星期二,",
                        "DaysOffWorkDay": "2025-02-08 星期六,2025-02-22 星期六,"
                    },
                    {
                        "NumberOfMonth": 3,
                        "WorkDays": "2025-03-03 星期一,2025-03-04 星期二,2025-03-05 星期三,2025-03-06 星期四,2025-03-07 星期五,2025-03-10 星期一,2025-03-11 星期二,2025-03-12 星期三,2025-03-13 星期四,2025-03-14 星期五,2025-03-17 星期一,2025-03-18 星期二,2025-03-19 星期三,2025-03-20 星期四,2025-03-21 星期五,2025-03-24 星期一,2025-03-25 星期二,2025-03-26 星期三,2025-03-27 星期四,2025-03-28 星期五,2025-03-31 星期一,",
                        "Weekend": "2025-03-01 星期六,2025-03-02 星期日,2025-03-09 星期日,2025-03-15 星期六,2025-03-16 星期日,2025-03-23 星期日,2025-03-29 星期六,2025-03-30 星期日,",
                        "Festivals": [],
                        "PublicHoliday": "",
                        "DaysOffWorkDay": "2025-03-08 星期六,2025-03-22 星期六,"
                    },
                    {
                        "NumberOfMonth": 4,
                        "WorkDays": "2025-04-01 星期二,2025-04-02 星期三,2025-04-03 星期四,2025-04-07 星期一,2025-04-08 星期二,2025-04-09 星期三,2025-04-10 星期四,2025-04-11 星期五,2025-04-14 星期一,2025-04-15 星期二,2025-04-16 星期三,2025-04-17 星期四,2025-04-18 星期五,2025-04-21 星期一,2025-04-22 星期二,2025-04-23 星期三,2025-04-24 星期四,2025-04-25 星期五,2025-04-28 星期一,2025-04-29 星期二,2025-04-30 星期三,",
                        "Weekend": "2025-04-13 星期日,2025-04-20 星期日,2025-04-26 星期六,",
                        "Festivals": [
                            {
                                "Date": "2025-04-04 星期五",
                                "Name": "清明节"
                            }
                        ],
                        "PublicHoliday": "2025-04-05 星期六,2025-04-06 星期日,",
                        "DaysOffWorkDay": "2025-04-12 星期六,2025-04-19 星期六,2025-04-27 星期日,"
                    },
                    {
                        "NumberOfMonth": 5,
                        "WorkDays": "2025-05-06 星期二,2025-05-07 星期三,2025-05-08 星期四,2025-05-09 星期五,2025-05-12 星期一,2025-05-13 星期二,2025-05-14 星期三,2025-05-15 星期四,2025-05-16 星期五,2025-05-19 星期一,2025-05-20 星期二,2025-05-21 星期三,2025-05-22 星期四,2025-05-23 星期五,2025-05-26 星期一,2025-05-27 星期二,2025-05-28 星期三,2025-05-29 星期四,2025-05-30 星期五,",
                        "Weekend": "2025-05-11 星期日,2025-05-18 星期日,2025-05-24 星期六,2025-05-25 星期日,",
                        "Festivals": [
                            {
                                "Date": "2025-05-01 星期四",
                                "Name": "劳动节"
                            },
                            {
                                "Date": "2025-05-02 星期五",
                                "Name": "劳动节"
                            },
                            {
                                "Date": "2025-05-31 星期六",
                                "Name": "端午节"
                            }
                        ],
                        "PublicHoliday": "2025-05-03 星期六,2025-05-04 星期日,2025-05-05 星期一,",
                        "DaysOffWorkDay": "2025-05-10 星期六,2025-05-17 星期六,"
                    },
                    {
                        "NumberOfMonth": 6,
                        "WorkDays": "2025-06-03 星期二,2025-06-04 星期三,2025-06-05 星期四,2025-06-06 星期五,2025-06-09 星期一,2025-06-10 星期二,2025-06-11 星期三,2025-06-12 星期四,2025-06-13 星期五,2025-06-16 星期一,2025-06-17 星期二,2025-06-18 星期三,2025-06-19 星期四,2025-06-20 星期五,2025-06-23 星期一,2025-06-24 星期二,2025-06-25 星期三,2025-06-26 星期四,2025-06-27 星期五,2025-06-30 星期一,",
                        "Weekend": "2025-06-08 星期日,2025-06-15 星期日,2025-06-21 星期六,2025-06-22 星期日,2025-06-29 星期日,",
                        "Festivals": [],
                        "PublicHoliday": "2025-06-01 星期日,2025-06-02 星期一,",
                        "DaysOffWorkDay": "2025-06-07 星期六,2025-06-14 星期六,2025-06-28 星期六,"
                    },
                    {
                        "NumberOfMonth": 7,
                        "WorkDays": "2025-07-01 星期二,2025-07-02 星期三,2025-07-03 星期四,2025-07-04 星期五,2025-07-07 星期一,2025-07-08 星期二,2025-07-09 星期三,2025-07-10 星期四,2025-07-11 星期五,2025-07-14 星期一,2025-07-15 星期二,2025-07-16 星期三,2025-07-17 星期四,2025-07-18 星期五,2025-07-21 星期一,2025-07-22 星期二,2025-07-23 星期三,2025-07-24 星期四,2025-07-25 星期五,2025-07-28 星期一,2025-07-29 星期二,2025-07-30 星期三,2025-07-31 星期四,",
                        "Weekend": "2025-07-05 星期六,2025-07-06 星期日,2025-07-13 星期日,2025-07-19 星期六,2025-07-20 星期日,2025-07-27 星期日,",
                        "Festivals": [],
                        "PublicHoliday": "",
                        "DaysOffWorkDay": "2025-07-12 星期六,2025-07-26 星期六,"
                    },
                    {
                        "NumberOfMonth": 8,
                        "WorkDays": "2025-08-01 星期五,2025-08-04 星期一,2025-08-05 星期二,2025-08-06 星期三,2025-08-07 星期四,2025-08-08 星期五,2025-08-11 星期一,2025-08-12 星期二,2025-08-13 星期三,2025-08-14 星期四,2025-08-15 星期五,2025-08-18 星期一,2025-08-19 星期二,2025-08-20 星期三,2025-08-21 星期四,2025-08-22 星期五,2025-08-25 星期一,2025-08-26 星期二,2025-08-27 星期三,2025-08-28 星期四,2025-08-29 星期五,",
                        "Weekend": "2025-08-02 星期六,2025-08-03 星期日,2025-08-10 星期日,2025-08-16 星期六,2025-08-17 星期日,2025-08-24 星期日,2025-08-30 星期六,2025-08-31 星期日,",
                        "Festivals": [],
                        "PublicHoliday": "",
                        "DaysOffWorkDay": "2025-08-09 星期六,2025-08-23 星期六,"
                    },
                    {
                        "NumberOfMonth": 9,
                        "WorkDays": "2025-09-01 星期一,2025-09-02 星期二,2025-09-03 星期三,2025-09-04 星期四,2025-09-05 星期五,2025-09-08 星期一,2025-09-09 星期二,2025-09-10 星期三,2025-09-11 星期四,2025-09-12 星期五,2025-09-15 星期一,2025-09-16 星期二,2025-09-17 星期三,2025-09-18 星期四,2025-09-19 星期五,2025-09-22 星期一,2025-09-23 星期二,2025-09-24 星期三,2025-09-25 星期四,2025-09-26 星期五,2025-09-29 星期一,2025-09-30 星期二,",
                        "Weekend": "2025-09-07 星期日,2025-09-13 星期六,2025-09-14 星期日,2025-09-21 星期日,2025-09-27 星期六,",
                        "Festivals": [],
                        "PublicHoliday": "",
                        "DaysOffWorkDay": "2025-09-06 星期六,2025-09-20 星期六,2025-09-28 星期日,"
                    },
                    {
                        "NumberOfMonth": 10,
                        "WorkDays": "2025-10-09 星期四,2025-10-10 星期五,2025-10-13 星期一,2025-10-14 星期二,2025-10-15 星期三,2025-10-16 星期四,2025-10-17 星期五,2025-10-20 星期一,2025-10-21 星期二,2025-10-22 星期三,2025-10-23 星期四,2025-10-24 星期五,2025-10-27 星期一,2025-10-28 星期二,2025-10-29 星期三,2025-10-30 星期四,2025-10-31 星期五,",
                        "Weekend": "2025-10-12 星期日,2025-10-19 星期日,2025-10-25 星期六,2025-10-26 星期日,",
                        "Festivals": [
                            {
                                "Date": "2025-10-01 星期三",
                                "Name": "国庆/中秋节"
                            },
                            {
                                "Date": "2025-10-02 星期四",
                                "Name": "国庆/中秋节"
                            },
                            {
                                "Date": "2025-10-03 星期五",
                                "Name": "国庆/中秋节"
                            },
                            {
                                "Date": "2025-10-06 星期一",
                                "Name": "国庆/中秋节"
                            }
                        ],
                        "PublicHoliday": "2025-10-04 星期六,2025-10-05 星期日,2025-10-07 星期二,",
                        "DaysOffWorkDay": "2025-10-08 星期三,2025-10-11 星期六,2025-10-18 星期六,"
                    },
                    {
                        "NumberOfMonth": 11,
                        "WorkDays": "2025-11-03 星期一,2025-11-04 星期二,2025-11-05 星期三,2025-11-06 星期四,2025-11-07 星期五,2025-11-10 星期一,2025-11-11 星期二,2025-11-12 星期三,2025-11-13 星期四,2025-11-14 星期五,2025-11-17 星期一,2025-11-18 星期二,2025-11-19 星期三,2025-11-20 星期四,2025-11-21 星期五,2025-11-24 星期一,2025-11-25 星期二,2025-11-26 星期三,2025-11-27 星期四,2025-11-28 星期五,",
                        "Weekend": "2025-11-02 星期日,2025-11-08 星期六,2025-11-09 星期日,2025-11-16 星期日,2025-11-22 星期六,2025-11-23 星期日,2025-11-30 星期日,",
                        "Festivals": [],
                        "PublicHoliday": "",
                        "DaysOffWorkDay": "2025-11-01 星期六,2025-11-15 星期六,2025-11-29 星期六,"
                    },
                    {
                        "NumberOfMonth": 12,
                        "WorkDays": "2025-12-01 星期一,2025-12-02 星期二,2025-12-03 星期三,2025-12-04 星期四,2025-12-05 星期五,2025-12-08 星期一,2025-12-09 星期二,2025-12-10 星期三,2025-12-11 星期四,2025-12-12 星期五,2025-12-15 星期一,2025-12-16 星期二,2025-12-17 星期三,2025-12-18 星期四,2025-12-19 星期五,2025-12-22 星期一,2025-12-23 星期二,2025-12-24 星期三,2025-12-25 星期四,2025-12-26 星期五,2025-12-29 星期一,2025-12-30 星期二,2025-12-31 星期三,",
                        "Weekend": "2025-12-06 星期六,2025-12-07 星期日,2025-12-14 星期日,2025-12-20 星期六,2025-12-21 星期日,2025-12-28 星期日,",
                        "Festivals": [],
                        "PublicHoliday": "",
                        "DaysOffWorkDay": "2025-12-13 星期六,2025-12-27 星期六,"
                    }
                ]
            }
        ],
        "Total": 1
    },
    "Code": 200,
    "Message": null
}'''

    try:
        processor = WorkCalendarProcessor()

        # 处理数据
        processor.process_work_calendar_data(json_data)

    except Exception as e:
        print(f"程序执行出错: {str(e)}")


if __name__ == "__main__":
    main()

